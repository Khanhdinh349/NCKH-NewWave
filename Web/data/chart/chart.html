<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Comparison Chart</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="chart.css" />
</head>
<body>
  <main class="wrap">
    <section class="card" aria-labelledby="title">
      <header class="card-head">
        <div class="head-left">
          <h1 id="title">Comparison Chart</h1>
          <!-- <p>Trục trái: % (Độ ẩm &amp; Độ ẩm đất) • Trục phải: °C (Nhiệt độ)</p> -->
        </div>
        <a class="btn" href="data.html">Back to Data</a>
      </header>

      <!-- Khung chart -->
      <div class="chart">
        <!-- <div class="axis axis-left">%</div>
        <div class="axis axis-right">°C</div> -->

        <!-- SVG vẽ động bằng JS -->
        <svg id="chart" viewBox="0 0 920 460" xmlns="http://www.w3.org/2000/svg" aria-label="Environmental time series"></svg>

        <!-- Legend có giá trị hiện tại -->
        <div class="legend" id="legend">
          <span><i class="dot" style="background:#f59e0b"></i> Nhiệt độ (°C): <b id="v-temp">—</b></span>
          <span><i class="dot" style="background:#2563eb"></i> Độ ẩm (%): <b id="v-hum">—</b></span>
          <span><i class="dot" style="background:#16a34a"></i> Độ ẩm đất (%): <b id="v-soil">—</b></span>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ====== CẤU HÌNH VẼ ======
    const svg = document.getElementById('chart');
    const W = 920, H = 460;
    const M = { left: 80, right: 880, top: 60, bottom: 380 };
    const COLOR = { temp: '#f59e0b', hum: '#2563eb', soil: '#16a34a', grid: '#e9edf2', axis: '#b7c0cb', tick: '#6b7280' };

    // Trục Y: 10..100 (cả trái & phải)
    const Y_MIN = 10, Y_MAX = 100;

    // Dữ liệu mẫu ban đầu
    let data = [
      { t: '2025-08-19', temp: 40, hum: 58, soil: 47 },
      { t: '2025-08-22', temp: 36, hum: 53, soil: 45 },
      { t: '2025-08-25', temp: 35, hum: 55, soil: 46 },
      { t: '2025-08-28', temp: 48, hum: 54, soil: 48 },
      { t: '2025-09-02', temp: 62, hum: 47, soil: 49 },
      { t: '2025-09-05', temp: 25, hum: 56, soil: 46 }
    ];

    // ====== HÀM TIỆN ÍCH ======
    const fmtDate = d => {
      const x = new Date(d);
      const dd = String(x.getDate()).padStart(2,'0');
      const mm = String(x.getMonth()+1).padStart(2,'0');
      const yyyy = x.getFullYear();
      return `${dd}-${mm}-${yyyy}`;
    };
    const scaleX = (i, n) => {
      const span = M.right - M.left;
      return M.left + (span * i) / (Math.max(n-1,1));
    };
    const scaleY = v => {
      const span = M.bottom - M.top;
      const r = (v - Y_MIN) / (Y_MAX - Y_MIN);
      return M.bottom - r * span;
    };
    const linePath = (arr, key) => {
      return arr.map((d,i) => `${i===0?'M':'L'}${scaleX(i, arr.length)},${scaleY(d[key])}`).join(' ');
    };

    // Vẽ trục, lưới, ticks
    function drawFrame() {
      svg.innerHTML = ''; // reset

      // Nền trong suốt để giữ kích thước
      const bg = document.createElementNS('http://www.w3.org/2000/svg','rect');
      bg.setAttribute('x', 0); bg.setAttribute('y', 0);
      bg.setAttribute('width', W); bg.setAttribute('height', H);
      bg.setAttribute('fill', 'transparent');
      svg.appendChild(bg);

      // Grid ngang theo 10..100
      for (let v=Y_MIN; v<=Y_MAX; v+=10) {
        const y = scaleY(v);
        const ln = document.createElementNS('http://www.w3.org/2000/svg','line');
        ln.setAttribute('x1', M.left); ln.setAttribute('y1', y);
        ln.setAttribute('x2', M.right); ln.setAttribute('y2', y);
        ln.setAttribute('stroke', COLOR.grid);
        svg.appendChild(ln);

        // nhãn bên trái
        const tx = document.createElementNS('http://www.w3.org/2000/svg','text');
        tx.setAttribute('x', M.left - 26);
        tx.setAttribute('y', y + 4);
        tx.setAttribute('fill', COLOR.tick);
        tx.setAttribute('font-size', '12');
        tx.textContent = v;
        svg.appendChild(tx);

        // nhãn bên phải
        const tx2 = document.createElementNS('http://www.w3.org/2000/svg','text');
        tx2.setAttribute('x', M.right + 5);
        tx2.setAttribute('y', y + 4);
        tx2.setAttribute('fill', COLOR.tick);
        tx2.setAttribute('font-size', '12');
        tx2.textContent = v;
        svg.appendChild(tx2);
      }

      // Trục
      const axes = [
        ['line', {x1:M.left, y1:M.top-10, x2:M.left, y2:M.bottom}],
        ['line', {x1:M.left, y1:M.bottom, x2:M.right, y2:M.bottom}],
        ['line', {x1:M.right, y1:M.top-10, x2:M.right, y2:M.bottom}],
      ];
      axes.forEach(([tag, attrs])=>{
        const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
        Object.entries(attrs).forEach(([k,v])=>el.setAttribute(k,v));
        el.setAttribute('stroke', COLOR.axis);
        el.setAttribute('stroke-width', '1.5');
        svg.appendChild(el);
      });

      // Ticks & nhãn trục X theo ngày
      data.forEach((d,i)=>{
        const x = scaleX(i, data.length);
        const tick = document.createElementNS('http://www.w3.org/2000/svg','line');
        tick.setAttribute('x1', x); tick.setAttribute('y1', M.bottom);
        tick.setAttribute('x2', x); tick.setAttribute('y2', M.bottom + 5);
        tick.setAttribute('stroke', '#c9d2dc');
        svg.appendChild(tick);

        const tx = document.createElementNS('http://www.w3.org/2000/svg','text');
        tx.setAttribute('x', x - 34);
        tx.setAttribute('y', M.bottom + 22);
        tx.setAttribute('fill', COLOR.tick);
        tx.setAttribute('font-size', '12');
        tx.textContent = fmtDate(d.t);
        svg.appendChild(tx);
      });
    }

    // Vẽ các đường
    function drawSeries() {
      const mk = (d, color) => {
        const p = document.createElementNS('http://www.w3.org/2000/svg','path');
        p.setAttribute('d', d);
        p.setAttribute('fill','none');
        p.setAttribute('stroke', color);
        p.setAttribute('stroke-width','3');
        svg.appendChild(p);
      };
      mk(linePath(data, 'temp'), COLOR.temp);
      mk(linePath(data, 'hum'),  COLOR.hum);
      mk(linePath(data, 'soil'), COLOR.soil);

      // cập nhật legend giá trị hiện tại (điểm cuối)
      const last = data[data.length-1] || {};
      document.getElementById('v-temp').textContent = last?.temp?.toFixed?.(1) ?? '—';
      document.getElementById('v-hum').textContent  = last?.hum ?.toFixed?.(1) ?? '—';
      document.getElementById('v-soil').textContent = last?.soil?.toFixed?.(1) ?? '—';
    }

    function render() {
      drawFrame();
      drawSeries();
    }

    // ====== API cập nhật liên tục ======
    window.pushData = function(dateISO, temp, hum, soil){
      data.push({ t: dateISO, temp, hum, soil });
      render();
    };

    // DEMO (có thể tắt đi nếu không muốn tự chạy)
    const ENABLE_DEMO = false;
    if (ENABLE_DEMO) {
      setInterval(()=>{
        const last = new Date(data[data.length-1].t);
        last.setDate(last.getDate()+2);
        const rand = (b, a)=> +(b + Math.random()*a).toFixed(1);
        pushData(last.toISOString().slice(0,10),
          Math.max(10, Math.min(100, rand(30, 15))),
          Math.max(10, Math.min(100, rand(45, 12))),
          Math.max(10, Math.min(100, rand(43, 10)))
        );
      }, 3000);
    }

    render();
  </script>
</body>
</html>
